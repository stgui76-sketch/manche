<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cercle des Quintes & Manche — Gammes/Modes Auto</title>
  <style>
    body { background: #212121; color: #eee; font-family: sans-serif; margin: 0;}
    header { padding: 18px 8px 2px;}
    h1 { margin:0 0 10px;}
    .toolbar { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin:12px;}
    .toolbar select, .toolbar input, .toolbar button { padding:6px 12px; font-size:16px; border-radius:8px; border:1px solid #444;}
    #cercleWrapper {margin:12px 0; justify-content: center; display: flex;}
    #cercle {position:relative; width: min(74vw,380px); height:min(74vw,380px); border-radius: 50%; background:#343142; display: flex; align-items:center; justify-content:center;}
    .noteCercle {position:absolute;width:40px;height:40px;border-radius:50%; background:#292;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:700;font-size:14px;}
    .noteCercle.selected {background: #ffb300;}
    #manche { position:relative; margin:24px auto 24px; width:96%; max-width:1360px; height:clamp(220px,40vw,340px); background:#463214; border-radius:12px; overflow:hidden;}
    .fret { position:absolute; top:0; bottom:0; width:2px; background:#b48c5a;}
    .string {position:absolute; left:0; right:0; height:2px; background: #d4b075;}
    .dot { position: absolute; width:14px; height:14px; background: #ecc759; border-radius: 50%; left:50%; transform: translateX(-50%); top:48%; }
    .dot.double::after { content: ""; position: absolute; width:14px; height:14px; background: #ecc759; border-radius:50%; top:-18px; left:0;}
    .fretNumber {
      position: absolute; bottom: 2px; left: 50%;
      transform: translateX(-50%);
      font-size: 12px; color: #b8905b; background: rgba(0,0,0,.25);
      padding: 2px 5px; border-radius: 6px;
    }
    .noteManche {position:absolute; width:24px; height:24px; border-radius:50%; background:#e7d6b1; color:#33220e; font-size:13px;font-weight:700; display:flex;align-items:center;justify-content:center;}
    .noteManche.tonic {background:#ffecb3;}
    .noteManche.diese {background:#3378f4;}
    .noteManche.bemol {background:#e55151;}
    @media (max-width: 600px) { .toolbar {flex-direction:column;} #cercle {width:220px;height:220px;} #manche{height:180px;} }
  </style>
</head>
<body>
<header>
  <h1>Cercle des quintes & manche — gammes et repères réels</h1>
  <div>Clique les notes du cercle, sélectionne une gamme pour l'afficher sur le manche (avec points & numéros) !</div>
</header>

<div class="toolbar">
  <select id="menuGammes" aria-label="Choix gamme"></select>
  <input type="number" min="12" max="36" value="24" id="nbFrettes" title="Nombre de frettes" />
  <select id="menuTuning"></select>
  <button id="helpBtn">?</button>
</div>

<div id="cercleWrapper">
  <div id="cercle" aria-label="Cercle des quintes"></div>
</div>
<div id="selectedScale" aria-live="polite"></div>
<div id="manche" aria-label="Manche de guitare"></div>
<footer>v4 — repères, gammes, filtres</footer>

<div id="modalHelp" style="display:none;position:fixed;top:20vh;left:50%;transform:translateX(-50%);background:rgba(30,30,44,0.98);color:#eee;padding:28px 14px;box-shadow:0 0 18px #111;z-index:10;border-radius:16px;">
  <strong>Aide:</strong><br/>
  - Clique notes du cercle<br/>
  - Choisis la gamme à afficher<br/>
  - Repères du manche visibles (points et numéros)<br/>
  <br/><button onclick="document.getElementById('modalHelp').style.display='block';">Fermer</button>
</div>

<script>
const SHARP_CHROMA = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const FLAT_TO_SHARP = { 'Cb':'B','Fb':'E','E#':'F','B#':'C', 'Bb':'A#','Eb':'D#','Ab':'G#','Db':'C#','Gb':'F#'};
function toSharp(n){ return FLAT_TO_SHARP[n] || n; }
const circleLabels = [
  {label:'C',pitch:'C'}, {label:'G',pitch:'G'}, {label:'D',pitch:'D'},
  {label:'A',pitch:'A'}, {label:'E',pitch:'E'}, {label:'B',pitch:'B'},
  {label:'F#/Gb',pitch:'F#'}, {label:'C#/Db',pitch:'C#'},
  {label:'G#/Ab',pitch:'G#'}, {label:'D#/Eb',pitch:'D#'},
  {label:'A#/Bb',pitch:'A#'}, {label:'F',pitch:'F'}
];

function allScales() {
  let all = {};
  const modes = [
    {type:'Ionien',         pattern:[2,2,1,2,2,2,1]},
    {type:'Dorien',         pattern:[2,1,2,2,2,1,2]},
    {type:'Phrygien',       pattern:[1,2,2,2,1,2,2]},
    {type:'Lydien',         pattern:[2,2,2,1,2,2,1]},
    {type:'Mixolydien',     pattern:[2,2,1,2,2,1,2]},
    {type:'Aeolien',        pattern:[2,1,2,2,1,2,2]},
    {type:'Locrien',        pattern:[1,2,2,1,2,2,2]}
  ];
  SHARP_CHROMA.forEach(root => {
    modes.forEach(m =>{
      let cur = [root], k = SHARP_CHROMA.indexOf(root);
      m.pattern.forEach(intv => { k = (k+intv)%12; cur.push(SHARP_CHROMA[k]); });
      cur.pop();
      all[`${root} ${m.type}`] = cur;
    });
    // Pentatonique majeure
    let pma = [root], p = SHARP_CHROMA.indexOf(root);
    [2,2,3,2,3].forEach(intv => { p = (p+intv)%12; pma.push(SHARP_CHROMA[p]); });
    pma.pop();
    all[`${root} Pentatonique majeure`] = pma;
    // Pentatonique mineure
    let pmi = [root], q = SHARP_CHROMA.indexOf(root);
    [3,2,2,3,2].forEach(intv => { q = (q+intv)%12; pmi.push(SHARP_CHROMA[q]); });
    pmi.pop();
    all[`${root} Pentatonique mineure`] = pmi;
    // Blues hexatonique
    let blu = [root], b = SHARP_CHROMA.indexOf(root);
    [3,2,1,1,3,2].forEach(intv => { b = (b+intv)%12; blu.push(SHARP_CHROMA[b]); });
    blu.pop();
    all[`${root} Blues`] = blu;
  });
  return all;
}
let gammes = allScales();

const defaultTunings = {
  'Guitare Standard': ['E','A','D','G','B','E'],
  'Basse 4 cordes': ['E','A','D','G'],
  'Guitare Drop D': ['D','A','D','G','B','E'],
  'Guitare 7 cordes': ['B','E','A','D','G','B','E'],
  'Guitare Open G': ['D','G','D','G','B','D']
};

const menuGammes = document.getElementById('menuGammes');
const manche = document.getElementById('manche');
const selTuning = document.getElementById('menuTuning');
const selectedScaleDiv = document.getElementById('selectedScale');

for(const k in defaultTunings){
  let opt = document.createElement('option');
  opt.textContent = k;
  selTuning.appendChild(opt);
}
let tuning = [...defaultTunings['Guitare Standard']];
selTuning.onchange = ()=>{ tuning = [...defaultTunings[selTuning.value]]; drawNeck(); };

let frets = 24;
document.getElementById('nbFrettes').onchange = e=>{ frets = +e.target.value; drawNeck(); };

const cercle = document.getElementById('cercle');
function buildCercle(){
  cercle.innerHTML='';
  circleLabels.forEach((obj, i) => {
    const el = document.createElement('div');
    el.className = 'noteCercle';
    el.textContent = obj.label;
    el.dataset.pitch = obj.pitch;
    const angle = (i * (2*Math.PI) / circleLabels.length) - Math.PI/2;
    const w = cercle.clientWidth, h=cercle.clientHeight;
    const cx = w/2, cy = h/2;
    const radius = Math.min(w,h)*0.39;
    el.style.left = `${cx + Math.cos(angle)*radius - 20}px`;
    el.style.top  = `${cy + Math.sin(angle)*radius - 20}px`;
    el.onclick = () => {
      el.classList.toggle('selected');
      updateGammesFromCircle();
    };
    cercle.appendChild(el);
  });
}
window.addEventListener('resize', buildCercle);
buildCercle();

function updateGammesFromCircle(){
  const selectedNotes = Array.from(document.querySelectorAll('.noteCercle.selected'))
    .map(el => el.dataset.pitch);

  let possibles = [];
  for (const [name, scale] of Object.entries(gammes)) {
    const scaleSharp = scale.map(toSharp);
    const matching = selectedNotes.length>0 && selectedNotes.every(note => scaleSharp.includes(toSharp(note)));
    if (matching) possibles.push(name);
  }
  fillScales(possibles.length ? possibles : ['(aucune compatible)']);
}

function fillScales(list=null){
  menuGammes.innerHTML = '';
  let gammesList = list || Object.keys(gammes);
  gammesList.forEach(gam => {
    const opt = document.createElement('option');
    opt.textContent = gam;
    menuGammes.appendChild(opt);
  });
  menuGammes.selectedIndex = 0;
  drawNeck();
}
menuGammes.onchange = drawNeck;

const dots = [3,5,7,9,12,15,17,19,21,24];
function drawNeck(){
  manche.innerHTML = '';
  const scaleName = menuGammes.value;
  const scale = gammes[scaleName] || [];
  for(let i=0; i<=frets; i++){
    let f = document.createElement('div');
    f.className = 'fret';
    f.style.left = (i/(frets+1))*100+'%';
    manche.appendChild(f);
    if(dots.includes(i)){
      const dot = document.createElement('div');
      dot.className = 'dot';
      dot.style.left = ((i - 0.5) * (100 / (frets+1))) + '%';
      dot.style.top = '50%';
      if(i === 12 || i === 24) dot.classList.add('double');
      manche.appendChild(dot);
      const numLabel = document.createElement('div');
      numLabel.className = 'fretNumber';
      numLabel.textContent = i;
      numLabel.style.left = ((i - 0.5) * (100 / (frets+1))) + '%';
      manche.appendChild(numLabel);
    }
  }
  tuning.forEach((t, i)=>{
    let s = document.createElement('div');
    s.className = 'string';
    let spacing = manche.clientHeight/(tuning.length+1);
    s.style.top = ((i+1)*spacing)+'px';
    manche.appendChild(s);
  });
  let fretWidth = 100/(frets+1);
  let h = manche.clientHeight;
  let spacing = h/(tuning.length+1);
  tuning.forEach((tune, s)=>{
    const openIndex = SHARP_CHROMA.indexOf(tune);
    for(let f=0; f<=frets; f++){
      const note = SHARP_CHROMA[(openIndex+f)%12];
      const displayNote = scale.includes(note)||scale.includes(Object.keys(FLAT_TO_SHARP).find(b=>FLAT_TO_SHARP[b]===note));
      if(displayNote){
        let el = document.createElement('div');
        el.className = 'noteManche';
        el.textContent = note;
        if(note.includes('#'))el.classList.add('diese');
        if(['Bb','Eb','Ab','Db','Gb'].includes(note))el.classList.add('bemol');
        if(note===scale[0])el.classList.add('tonic');
        el.style.left = `${(f*fretWidth)+fretWidth/2}%`;
        el.style.top = `${(s+1)*spacing}px`;
        manche.appendChild(el);
      }
    }
  });
  selectedScaleDiv.textContent = `${scaleName} — Notes : ${scale.join('  ')}`;
}

document.getElementById('helpBtn').onclick = ()=>{ document.getElementById('modalHelp').style.display='block'; };

fillScales();
drawNeck();
</script>
</body>
</html>
